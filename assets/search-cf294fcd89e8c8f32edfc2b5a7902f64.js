(function($){var debounce=function(fn){var timeout;var slice=Array.prototype.slice;return function(){var args=slice.call(arguments),ctx=this;clearTimeout(timeout);timeout=setTimeout(function(){fn.apply(ctx,args)},100)}};var parseDate=function(input){var parts=input.match(/(\d+)/g);return new Date(parts[0],parts[1]-1,parts[2])};var LunrSearch=(function(){function LunrSearch(elem,options){this.$elem=elem;this.$results=$(options.results);this.$entries=$(options.entries,this.$results);this.indexDataUrl=options.indexUrl;this.index=this.createIndex();this.template=this.compileTemplate($(options.template));this.initialize()}LunrSearch.prototype.initialize=function(){var self=this;this.loadIndexData(function(data){self.populateIndex(data);self.populateSearchFromQuery();self.bindKeypress()})};LunrSearch.prototype.createIndex=function(){return lunr(function(){this.field("title",{boost:10});this.field("body");this.ref("id")})};LunrSearch.prototype.compileTemplate=function($template){var template=$template.text();Mustache.parse(template);return function(view,partials){return Mustache.render(template,view,partials)}};LunrSearch.prototype.loadIndexData=function(callback){$.getJSON(this.indexDataUrl,callback)};LunrSearch.prototype.populateIndex=function(data){var index=this.index;this.entries=$.map(data.entries,this.createEntry);$.each(this.entries,function(idx,entry){index.add(entry)})};LunrSearch.prototype.createEntry=function(raw,index){var entry=$.extend({id:index+1},raw);if(raw.date){$.extend(entry,{date:parseDate(raw.date),pubdate:function(){return dateFormat(parseDate(raw.date),"yyyy-mm-dd")},displaydate:function(){return dateFormat(parseDate(raw.date),"mmm dd, yyyy")}})}return entry};LunrSearch.prototype.bindKeypress=function(){var self=this;var oldValue=this.$elem.val();this.$elem.bind("keyup",debounce(function(){var newValue=self.$elem.val();if(newValue!==oldValue){self.search(newValue)}oldValue=newValue}))};LunrSearch.prototype.search=function(query){var entries=this.entries;if(query.length<2){this.$results.hide();this.$entries.empty()}else{var results=$.map(this.index.search(query),function(result){return $.grep(entries,function(entry){return entry.id===parseInt(result.ref,10)})[0]});this.displayResults(results)}};LunrSearch.prototype.displayResults=function(entries){var $entries=this.$entries,$results=this.$results;$entries.empty();if(entries.length===0){$entries.append("<p>Vi letade överallt men kunde tyvärr inte hitta det du sökte efter...</p>")}else{$entries.append(this.template({entries:entries}))}$results.show()};LunrSearch.prototype.populateSearchFromQuery=function(){var uri=new URI(window.location.search.toString());var queryString=uri.search(true);if(queryString.hasOwnProperty("q")){this.$elem.val(queryString.q);this.search(queryString.q.toString())}};return LunrSearch})();$.fn.lunrSearch=function(options){options=$.extend({},$.fn.lunrSearch.defaults,options);new LunrSearch(this,options);return this};$.fn.lunrSearch.defaults={indexUrl:"/search.json",results:"#search-results",entries:".entries",template:"#search-results-template"}})(jQuery);